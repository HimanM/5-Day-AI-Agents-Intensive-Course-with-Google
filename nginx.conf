# ADK Agents - Nginx Configuration
# This config proxies Next.js frontend and restricts ADK API endpoints to prevent abuse.

upstream adk_api {
  server 127.0.0.1:8080;
}

upstream nextjs_web {
  server 127.0.0.1:3000;
}

server {
  listen 80;
  server_name localhost;  # Replace with your domain in production

  # Security headers
  add_header X-Content-Type-Options nosniff;
  add_header X-Frame-Options DENY;
  add_header Referrer-Policy strict-origin-when-cross-origin;

  # Next.js static assets and pages
  location /_next/ {
    proxy_pass http://nextjs_web;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
  }

  # Next.js app root
  location / {
    proxy_pass http://nextjs_web;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
  }

  # ADK API - Allow-list only required endpoints
  # GET /api/list-apps
  location = /api/list-apps {
    proxy_pass http://adk_api/list-apps;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
  }

  # Session management: POST/GET/DELETE /api/apps/{app}/users/{user}/sessions/{session}
  location ~ ^/api/apps/([^/]+)/users/([^/]+)/sessions/([^/]+)$ {
    proxy_pass http://adk_api$request_uri;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
  }

  # Run single response: POST /api/run
  location = /api/run {
    proxy_pass http://adk_api/run;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
  }

  # Run SSE streaming: POST /api/run_sse
  location = /api/run_sse {
    proxy_pass http://adk_api/run_sse;
    proxy_http_version 1.1;
    proxy_set_header Connection '';
    proxy_set_header Host $host;
    chunked_transfer_encoding off;
    proxy_buffering off;
    proxy_cache off;
    proxy_read_timeout 1h;
  }

  # Block all other /api paths (e.g. /docs, /openapi.json, etc)
  location ^~ /api/ {
    return 403;
  }
}
