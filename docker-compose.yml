version: '3.8'

# Load environment variables from .env.docker file
# Create this file and set your DOMAIN and GOOGLE_API_KEY

services:
  # ADK Agents Backend
  agents:
    build:
      context: ./Agents
      dockerfile: Dockerfile
    container_name: adk-agents
    restart: unless-stopped
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GOOGLE_GENAI_USE_VERTEXAI=${GOOGLE_GENAI_USE_VERTEXAI:-false}
      - DOMAIN=${DOMAIN:-localhost}
    ports:
      - "8080:8080"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/list-apps"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Next.js Frontend
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    container_name: nextjs-web
    restart: unless-stopped
    environment:
      - DOMAIN=${DOMAIN:-localhost}
      - ADK_SERVER_URL=http://agents:8080
    ports:
      - "3000:3000"
    networks:
      - app-network
    depends_on:
      agents:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: nginx-proxy
    restart: unless-stopped
    environment:
      - DOMAIN=${DOMAIN:-localhost}
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx-docker.conf.template:/etc/nginx/templates/default.conf.template:ro
      # Uncomment below for SSL certificates
      # - ./ssl:/etc/nginx/ssl:ro
    networks:
      - app-network
    depends_on:
      web:
        condition: service_healthy
      agents:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost/api/list-apps"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  app-network:
    driver: bridge
